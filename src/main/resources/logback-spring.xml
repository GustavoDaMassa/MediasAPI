<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- Include Spring Boot's default configurations -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- Variable for the application name from application.properties -->
    <springProperty scope="context" name="springAppName" source="spring.application.name" defaultValue="medias-api"/>

    <!-- Appender for JSON logs to the console (stdout) -->
    <appender name="STDOUT_JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"app_name":"${springAppName}"}</customFields>
            <includeMdc>true</includeMdc>
        </encoder>
    </appender>

    <!-- Appender for sending JSON logs to Logstash via TCP (only for docker profile) -->
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>logstash:5000</destination>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"app_name":"${springAppName}"}</customFields>
            <includeMdc>true</includeMdc>
        </encoder>
    </appender>

    <!-- Production profile: only STDOUT_JSON (CloudWatch captures via awslogs driver) -->
    <springProfile name="prod">
        <root level="WARN">
            <appender-ref ref="STDOUT_JSON"/>
        </root>
        <logger name="br.com.gustavohenrique.MediasAPI" level="INFO"/>
        <logger name="org.flywaydb" level="INFO"/>
    </springProfile>

    <!-- Docker profile: STDOUT_JSON + Logstash TCP (for ELK Stack) -->
    <springProfile name="docker">
        <root level="INFO">
            <appender-ref ref="STDOUT_JSON"/>
            <appender-ref ref="LOGSTASH"/>
        </root>
    </springProfile>

    <!-- Default profile (local development): only STDOUT_JSON -->
    <springProfile name="default">
        <root level="INFO">
            <appender-ref ref="STDOUT_JSON"/>
        </root>
    </springProfile>

    <!-- Fallback for any other profiles -->
    <springProfile name="!prod,!docker,!default">
        <root level="INFO">
            <appender-ref ref="STDOUT_JSON"/>
        </root>
    </springProfile>

</configuration>
